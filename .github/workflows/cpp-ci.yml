name: C++ Homework CI

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ cmake make
    
    - name: List homework directories
      run: |
        echo "=== Найденные домашние работы ==="
        find . -maxdepth 1 -type d -name "hw*" | sort
        echo ""
    
    - name: Build all homework
      run: |
        echo "=== Сборка всех домашних работ ==="
        make all
        echo ""
        echo "=== Созданные исполняемые файлы ==="
        find . -name "main" -type f -executable | sort
    
    - name: Run tests (if any)
      run: |
        echo "=== Запуск программ ==="
        make test || echo "Нет программ для запуска"
    
    - name: Check for compilation artifacts
      run: |
        echo "=== Проверка на наличие артефактов сборки ==="
        if find . -name "*.o" -o -name "*.out" -o -name "*.exe" | grep -q .; then
          echo "ВНИМАНИЕ: Найдены файлы сборки в репозитории!"
          find . -name "*.o" -o -name "*.out" -o -name "*.exe"
          echo "Убедитесь, что они добавлены в .gitignore"
          exit 1
        else
          echo "✓ Артефактов сборки нет (отлично!)"
        fi
    - name: Lint with clang-format
      run: |
        sudo apt-get install -y clang-format
        echo "=== Проверка форматирования ==="
        find . -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror || echo "Форматирование не соответствует стандарту"
