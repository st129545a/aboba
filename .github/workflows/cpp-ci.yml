name: C++ Homework CI

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ cmake make
    
    - name: List homework directories
      run: |
        echo "=== Найденные домашние работы ==="
        find . -maxdepth 1 -type d -name "hw*" | sort
        echo ""
    
    - name: Build all homework
      run: |
        echo "=== Сборка всех домашних работ ==="
        make all
        echo ""
        echo "=== Созданные исполняемые файлы ==="
        find . -name "main" -type f -executable | sort
    
    - name: Run tests (if any)
      run: |
        echo "=== Запуск программ ==="
        make test || echo "Нет программ для запуска"
    
    - name: Check for compilation artifacts
      run: |
        echo "=== Проверка на наличие артефактов сборки ==="
        if find . -name "*.o" -o -name "*.out" -o -name "*.exe" | grep -q .; then
          echo "ВНИМАНИЕ: Найдены файлы сборки в репозитории!"
          find . -name "*.o" -o -name "*.out" -o -name "*.exe"
          echo "Убедитесь, что они добавлены в .gitignore"
          exit 1
        else
          echo "✓ Артефактов сборки нет (отлично!)"
        fi
    - name: Lint with clang-format
      run: |
        sudo apt-get install -y clang-format
        echo "=== Проверка форматирования ==="
        find . -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror || echo "Форматирование не соответствует стандарту"
    - name: Build with sanitizers
      run: |
        echo "=== Сборка с санитайзерами ==="
        for dir in $(find . -maxdepth 1 -type d -name "hw*" | sort); do
          if [ -f "$dir/main.cpp" ]; then
            echo "Сборка $dir с AddressSanitizer..."
            cd "$dir"
            g++ -std=c++11 -fsanitize=address -fno-omit-frame-pointer -g -o main_sanitized main.cpp
            cd ..
          fi
        done
    
    - name: Run sanitized programs
      run: |
        echo "=== Запуск с санитайзерами ==="
        for dir in $(find . -maxdepth 1 -type d -name "hw*" | sort); do
          if [ -f "$dir/main_sanitized" ] && [ -x "$dir/main_sanitized" ]; then
            echo "Запуск $dir/main_sanitized"
            cd "$dir"
            ASAN_OPTIONS=detect_leaks=1 ./main_sanitized 2>&1 || true
            cd ..
          fi
        done
